var hotelList=angular.module("hotelList",[]);hotelList.factory("hotel_room_allo",function(e){var o={};return o.data=[],o.raw=[],o.prepForBroadcast=function(e){this.data=e,this.broadcastItem()},o.broadcastItem=function(){e.$broadcast("handleBroadcast")},o}),hotelList.directive("hotelDetail",function(){return function(e,o,t){e.getHdetails(o,t.hotelcode)}}),hotelList.directive("hotelStar",function(){return function(e,o,t){for($rate=parseInt(t.rate.substring(0,1)),$ratehtml="",$r=0;$rate>$r;$r++)$ratehtml+=' <span class="icon-star"></span>';o.context.innerHTML=$ratehtml}}),hotelList.controller("hotelList",["$scope","searchData","hotelData","hotelListRs","purchaseData","travelPackD","serviceAddRs","hotel_room_allo","hotelShortDetailsRs","$location",function(e,o,a,r,l,s,i,n,h,m){function u(e,o,t){var a=new Date;a.setTime(a.getTime()+24*t*60*60*1e3);var r="expires="+a.toUTCString();document.cookie=e+"="+JSON.stringify(o)+"; "+r}function d(e){for(var o=e+"=",t=document.cookie.split(";"),a=0;a<t.length;a++){var r=t[a].trim();if(0==r.indexOf(o))return r.substring(o.length,r.length)}return""}function p(e){var o=d(e);return""!=o?JSON.parse(o):void 0}function _(o){e.cust=[];var t=o.HotelOccupancy.Occupancy.GuestList.Customer;if(Array.isArray(t)){var a=[];for(total_guest=t.length,c=0;total_guest>c;c++)guest_det={cust_id:t[c].CustomerId,cust_type:t[c]["@type"],cust_age:t[c].Age},a.push(guest_det);return e.cust=a,e.cust}return guest_det={cust_id:t.CustomerId,cust_type:t["@type"],cust_age:t.Age},e.cust=guest_det,e.cust}e.getData=o.data(),console.log(e.getData),e.travelPD=s.data(),e.offer="",e.filter={lp:null,hp:null},e.minP=null,e.maxP=null,e.minPrice=0,e.maxPrice=5e9,e.sort="AvailableRoom[0].HotelRoom.Price.Amount || AvailableRoom.HotelRoom.Price.Amount",e.sorting=[{name:"Lowest Price",value:"AvailableRoom[0].HotelRoom.Price.Amount || AvailableRoom.HotelRoom.Price.Amount"},{name:"Highest Price",value:"-AvailableRoom[0].HotelRoom.Price.Amount || -AvailableRoom.HotelRoom.Price.Amount"},{name:"Lowest Star Rating",value:'HotelInfo.Category["@shortname"]'},{name:"Higest Star Rating",value:'-HotelInfo.Category["@shortname"]'},{name:"Hotel Name Asc.",value:"HotelInfo.Name"},{name:"Hotel Name Desc.",value:"-HotelInfo.Name"}],e.priceMin=function(o){return o.AvailableRoom instanceof Array?parseFloat(o.AvailableRoom[0].HotelRoom.Price.Amount)>=e.minPrice:parseFloat(o.AvailableRoom.HotelRoom.Price.Amount)>=e.minPrice},e.priceMax=function(o){return o.AvailableRoom instanceof Array?parseFloat(o.AvailableRoom[0].HotelRoom.Price.Amount)<=e.maxPrice:parseFloat(o.AvailableRoom.HotelRoom.Price.Amount)<=e.maxPrice},e.applyfilter=function(){e.minPrice=e.minP,e.maxP>0&&e.maxP>e.minP&&(e.maxPrice=e.maxP)},0==e.getData[1].htotalnight?(console.log("heresdf"),e.search_c=p("Last_Search"),e.travelPD=p("travelPD")):(e.search_c=e.getData[1],u("Last_Search",e.search_c,30),u("travelPD",e.travelPD,30)),e.Dest=e.search_c.hdesdesc,f=e.search_c.hcheckin,t=e.search_c.hcheckout;var v=[f.slice(0,4),f.slice(4,6),f.slice(6)].join(" ");$fday=moment(v).format("DD MMMM YYYY"),console.log($fday),$t=$fday.split(" "),e.f_day=$t[0],e.f_month=$t[1],e.f_year=$t[2];var g=[t.slice(0,4),t.slice(4,6),t.slice(6)].join(" ");$tday=moment(g).format("DD MMMM YYYY"),console.log($tday),$dt=$tday.split(" "),e.t_day=$dt[0],e.t_month=$dt[1],e.t_year=$dt[2],jQuery("#to_complete, #from_complete, #transfer_hp_complete, #transfer_hd_complete").autocomplete({source:"server/hotel_autocomplete.php",minLength:3,select:function(o,t){var a=t.item.id,r=t.item.value;"#"!=a&&("Flights"!=e.curr_search.service?(e.getData[1].hdescode=a,e.getData[1].hdesdesc=r,$sour=$(this).attr("name"),"des"==$sour?(currSearch.setDes(a),e.hd_city=a,console.log(a)):"dep"==$sour&&(currSearch.setDep(a),e.hp_city=a,console.log(a))):($f_des_air="LHR",$sour=$(this).attr("name"),"dep"==$sour?(e.dep_airp_code=a,e.dep_airp_name=r,e.getData[0].fDepAirpCode=a[0],e.getData[0].fDepAirpName=r):(e.des_airp_code=a,e.des_airp_name=r,e.getData[0].fDesAirpCode=a[0],e.getData[0].fDesAirpName=r)))},html:!0,open:function(){jQuery(".ui-autocomplete").css("z-index",1e3)}}),e.hList=r.get({hAdult:e.search_c.hAdult,hChild:e.search_c.hChild,hdescode:e.search_c.hdescode,hcheckin:e.search_c.hcheckin,hcheckout:e.search_c.hcheckout,hRoomBreak:JSON.stringify(e.search_c.hRoomBreak)},function(){e.hotels_total=e.hList.HotelValuedAvailRS["@totalItems"],e.hotels=e.hList.HotelValuedAvailRS.ServiceHotel,console.log(e.hotels);try{e.lowest_price=e.hotels[0].AvailableRoom[0].HotelRoom.Price.Amount}catch(o){e.lowest_price=parseFloat(e.hotels[0].AvailableRoom.HotelRoom.Price.Amount)}var t=0;console.log(e.lowest_price);for(property in e.hotels)if(e.hotels.hasOwnProperty(property)){if(e.hotels instanceof Array)var a=e.hotels[property];else var a=e.hotels;var r=(e.lowest_price,a.AvailableRoom);t=r instanceof Array?parseFloat(r[0].HotelRoom.Price.Amount):parseFloat(r.HotelRoom.Price.Amount),t<e.lowest_price&&(console.log(t),e.lowest_price=t)}}),e.roomnum=0,e.search_c.hAdult=0,e.search_c.hChild=0;for(property in e.search_c.hRoomBreak)e.search_c.hRoomBreak.hasOwnProperty(property)&&(e.search_c.hAdult=e.search_c.hRoomBreak[property][1]+e.search_c.hAdult,e.search_c.hChild=e.search_c.hRoomBreak[property][2].length+e.search_c.hChild);e.getHdetails=function(o,t){e.hsdet=h.get({hotel_code:t},function(e){o.context.innerHTML=e.det})},e.sethotels_details=function(o,t){e.getData[1].hcode=o.target.attributes.name.value,e.getData[1].hname=o.target.attributes.hname.value;var r=JSON.parse($("#new_list").val());e.hot=r[t],a.setData(e.hot),m.path("/hotel/hotel_details")},e.book_room=function(o,t,r){var c=JSON.parse($("#new_list").val());e.hot=c[t],$selected_rooms=[],console.log(r),Array.isArray(e.hot.AvailableRoom)?0==r?$selected_rooms.push(e.hot.AvailableRoom[r]):$selected_rooms=r:$selected_rooms.push(e.hot.AvailableRoom),e.purchaseD=l.data(),e.purchaseT="none",null!=e.purchaseD[0]&&(e.purchaseT=e.purchaseD[0]["@purchaseToken"]),e.hservAdd=i.get({pToken:e.purchaseT,Availtoken:e.hot["@availToken"],contractName:e.hot.ContractList.Contract.Name,contractCode:e.hot.ContractList.Contract.IncomingOffice["@code"],Guest:JSON.stringify(e.search_c.hRoomBreak),bookData:JSON.stringify($selected_rooms),DateFrom:e.search_c.hcheckin,Troom:e.search_c.hTotalroom,ServiceType:"ServiceHotel",DateTo:e.search_c.hcheckout,hotelcode:e.hot.HotelInfo.Code,destcode:e.search_c.hdescode},function(o){if(e.serv=o.ServiceAddRS.Purchase.ServiceList.Service,a.setData(o),console.log(o),console.log(e.serv),e.services=[],e.roomz=[],Array.isArray(e.serv)){console.log("here at if");for(var t=0;t<e.services.length;t++)e.services.push(e.serv[t])}else console.log("here at else"),e.services.push(e.serv);if(e.search_c.hTotalroom>1)for(t=0;t<e.search_c.hTotalroom;t++)e.cust=_(e.serv.AvailableRoom[t]),roomz={board:e.serv.AvailableRoom[t].HotelRoom.Board.$,roomtype:e.serv.AvailableRoom[t].HotelRoom.RoomType.$,cancel:e.serv.AvailableRoom[t].HotelRoom.CancellationPolicies,price:$selected_rooms[t].HotelRoom.Price.Amount,guest_details:null,cust_det:e.cust},e.roomz.push(roomz);else e.cust=_(e.serv.AvailableRoom),roomz={board:e.serv.AvailableRoom.HotelRoom.Board.$,roomtype:e.serv.AvailableRoom.HotelRoom.RoomType.$,cancel:e.serv.AvailableRoom.HotelRoom.CancellationPolicies,price:$selected_rooms[0].HotelRoom.Price.Amount,guest_details:null,cust_det:e.cust},e.roomz.push(roomz);for(var t=0;t<e.services.length;t++)"ServiceHotel"==e.serv["@xsi:type"]&&(console.log("here at servHotel"),travel_pack={product:"Hotelbeds",productType:"Hotel",Adult:e.search_c.hAdult,Child:e.search_c.hChild,hdesdesc:e.search_c.hdesdesc,hcheckin:e.search_c.hcheckin,hcheckout:e.search_c.hcheckout,imgurl:e.hot.HotelInfo.ImageList.Image[0].Url,Name:e.hot.HotelInfo.Name,hStar:e.hot.HotelInfo.Category.$,hRoom:e.search_c.hTotalroom,Price:e.serv.TotalAmount,Spui:e.serv["@SPUI"],roomBreak:e.roomz,purchaseToken:e.hservAdd.ServiceAddRS.Purchase["@purchaseToken"],total_nights:e.search_c.htotalnight,hroomdist:e.search_c.hRoomBreak}),s.setData(travel_pack),u("travelPD",s.data(),30),m.path("/travel_pack"),console.log(s.data());console.log(travel_pack)})}}]),hotelList.directive("roomType",function(){return{restrict:"E",templateUrl:"template/hotel_rate.html",controller:function(e,o,t){function a(o){for(e.room_allo=[],e.roomBreak=[],o=JSON.parse(o);e.room_allo.push([])<e.search_c.hTotalroom;);for(;e.roomBreak.push([])<e.search_c.hTotalroom;);for($i=0;$i<e.search_c.hTotalroom;$i++){var t=0;for(property in o)if(o.hasOwnProperty(property)){if(o instanceof Array){var a=o[property];console.log(a)}else var a=o;var r=a.HotelOccupancy.Occupancy;r.AdultCount==e.search_c.hRoomBreak[$i][1]&&r.ChildCount==e.search_c.hRoomBreak[$i][2].length&&(e.room_allo[$i].push(a),t++,1==t&&(e.roomTotalPrice[$i+1]=a.HotelRoom.Price.Amount,e.roomBreak[$i]=a,console.log(e.roomBreak[$i])))}}}function r(){for(e.totalPrice=0,$i=1;$i<e.roomTotalPrice.length;$i++)e.totalPrice=parseFloat(e.totalPrice)+parseFloat(e.roomTotalPrice[$i]);e.roomTotalPrice[0]=e.totalPrice.toFixed(2)}function c(o,t,a,r){objects=[];for(var l in o)if(o.hasOwnProperty(l)&&"object"==typeof o[l])try{o[l].Board.$==t&&o[l].RoomType.$==a?(console.log(o[l]),o.HotelOccupancy.Occupancy.AdultCount==e.search_c.hRoomBreak[r][1]&&o.HotelOccupancy.Occupancy.ChildCount==e.search_c.hRoomBreak[r][2].length?objects.push(o):objects=objects.concat(c(o[l],t,a,r))):objects=objects.concat(c(o[l],t,a,r))}catch(s){objects=objects.concat(c(o[l],t,a,r))}return objects}e.$on("handleBroadcast",function(){e.room_all=t.data}),e.roomTotalPrice=[0,0,0,0,0,0,0],a(e.room_all),r(),e.get_room_type=function(o,t,a){e.roomtype=o,e.board=t,console.log(e.roomBreak),e.att=c(e.room_allo,e.board,e.roomtype,a),e.roomBreak[a]=e.att[0],console.log(e.roomBreak),console.log(e.att),e.roomTotalPrice[a+1]=e.att[0].HotelRoom.Price.Amount,r()},e.get_room_board=function(o,t,a){e.roomtype=o,e.board=t,e.att=c(e.room_allo,e.board,e.roomtype,a),e.roomBreak[a]=e.att[0],console.log(e.roomBreak),console.log(e.att),e.roomTotalPrice[a+1]=e.att[0].HotelRoom.Price.Amount,r()}}}}),hotelList.directive("hotelspecroom",function(e,o){return{link:function(t,a,r){a.bind("click",function(){if(a.parent().parent().parent().children(".view_all_boards").length)$(".view_all_boards").remove();else{t.room_all=r.roomz,t.ind=r.name,o.prepForBroadcast(t.room_all),t.$on("handleBroadcast",function(){t.room_all=o.data});var c=e("<room-type class='col-md-18 nopadding'></room-type>")(t);a.parent().parent().parent().append(c)}a.parent().parent().siblings(".hideme").toggleClass("showme"),a.children(".minus_ic").toggleClass("showme"),a.children(".plus_ic").toggleClass("hideme")})}}});